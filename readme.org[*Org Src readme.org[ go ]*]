import (
	"github.com/abdullin/omni/core/env"
	"github.com/abdullin/omni/core/spec"
	"github.com/abdullin/omni/lang"
)

func when_post_inbox_task_then_event_is_published() *env.UseCase {

	newTaskId := lang.NewTaskId()

	return &env.UseCase{
		Name: "When POST /task for inbox, then 2 events are published",
		When: spec.PostJSON("/task", seq.Map{
			"name":  "NewTask",
			"inbox": true,
		}),
		ThenResponse: spec.ReturnJSON(seq.Map{
			"name":   "NewTask",
			"inbox":  "true",
			"taskId": newTaskId,
		}),
		ThenEvents: spec.Events(
			lang.NewTaskAdded(IgnoreEventId, newTaskId, "NewTask"),
			lang.NewTaskMovedToInbox(IgnoreEventId, newTaskId),
		),
		Where: spec.Where{
			newTaskId:     "sameTaskId",
			IgnoreEventId: "ignore",
		},
	}
}
